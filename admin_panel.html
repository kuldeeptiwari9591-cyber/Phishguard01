<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>PhishGuard Admin Panel</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d1117;--surface:#161b22;--surface2:#1c2128;--border:#30363d;
  --text:#f0f6fc;--text2:#8b949e;--text3:#484f58;
  --blue:#2563eb;--blue-dark:#1d4ed8;--blue-glow:rgba(37,99,235,.3);
  --green:#22c55e;--yellow:#f59e0b;--red:#ef4444;--purple:#a855f7;
  --sidebar:240px;
}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;font-size:14px;display:flex}

/* â”€â”€ SIDEBAR â”€â”€ */
#sidebar{
  width:var(--sidebar);min-width:var(--sidebar);
  background:var(--surface);border-right:1px solid var(--border);
  display:flex;flex-direction:column;height:100vh;overflow:hidden;
}
.sidebar-header{
  padding:20px 16px 14px;
  border-bottom:1px solid var(--border);
}
.sidebar-logo{
  display:flex;align-items:center;gap:10px;
}
.logo-icon{
  width:36px;height:36px;background:linear-gradient(135deg,var(--blue),var(--blue-dark));
  border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.logo-icon svg{width:20px;height:20px}
.logo-text{font-size:15px;font-weight:700;color:var(--text)}
.logo-sub{font-size:10px;color:var(--text2);margin-top:1px}
.admin-badge{
  display:inline-block;background:rgba(37,99,235,.15);border:1px solid rgba(37,99,235,.3);
  color:#60a5fa;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;
  padding:2px 7px;border-radius:4px;margin-top:8px;
}
nav{flex:1;overflow-y:auto;padding:12px 8px}
.nav-section{color:var(--text3);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;padding:8px 8px 4px;margin-top:4px}
.nav-item{
  display:flex;align-items:center;gap:10px;
  padding:9px 10px;border-radius:8px;
  color:var(--text2);cursor:pointer;transition:all .15s;
  font-size:13px;font-weight:500;
  position:relative;
}
.nav-item:hover{background:var(--surface2);color:var(--text)}
.nav-item.active{background:rgba(37,99,235,.15);color:#60a5fa}
.nav-item.active::before{
  content:'';position:absolute;left:0;top:4px;bottom:4px;
  width:3px;background:var(--blue);border-radius:0 3px 3px 0;
}
.nav-item svg{width:17px;height:17px;flex-shrink:0}
.nav-item .badge-count{
  margin-left:auto;background:var(--red);color:#fff;
  font-size:10px;font-weight:700;padding:1px 6px;border-radius:10px;
}
.sidebar-footer{
  padding:12px;border-top:1px solid var(--border);
}
.logout-btn{
  width:100%;display:flex;align-items:center;justify-content:center;gap:8px;
  background:rgba(220,38,38,.1);border:1px solid rgba(220,38,38,.2);
  color:#f87171;border-radius:8px;padding:9px;cursor:pointer;
  font-size:13px;font-weight:600;transition:all .2s;
}
.logout-btn:hover{background:rgba(220,38,38,.2)}

/* â”€â”€ MAIN â”€â”€ */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{
  background:var(--surface);border-bottom:1px solid var(--border);
  padding:0 24px;height:56px;display:flex;align-items:center;justify-content:space-between;
  flex-shrink:0;
}
.page-title{font-size:16px;font-weight:700}
.topbar-right{display:flex;align-items:center;gap:12px}
.status-dot{
  width:8px;height:8px;border-radius:50%;background:var(--green);
  box-shadow:0 0 6px var(--green);
}
.admin-chip{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:20px;padding:4px 12px 4px 8px;
  display:flex;align-items:center;gap:6px;font-size:12px;
}
.admin-avatar{
  width:24px;height:24px;background:linear-gradient(135deg,var(--blue),var(--purple));
  border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;
}

#content{flex:1;overflow-y:auto;padding:24px}

/* â”€â”€ PANELS â”€â”€ */
.panel{display:none}
.panel.active{display:block}

/* â”€â”€ STATS GRID â”€â”€ */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;margin-bottom:24px}
.stat-card{
  background:var(--surface);border:1px solid var(--border);border-radius:12px;
  padding:18px 20px;position:relative;overflow:hidden;
}
.stat-card::after{
  content:'';position:absolute;top:0;right:0;width:60px;height:60px;
  border-radius:0 12px 0 60px;
  opacity:.08;
}
.stat-card.blue::after  {background:var(--blue)}
.stat-card.red::after   {background:var(--red)}
.stat-card.yellow::after{background:var(--yellow)}
.stat-card.green::after {background:var(--green)}
.stat-card.purple::after{background:var(--purple)}
.stat-label{font-size:11px;text-transform:uppercase;letter-spacing:.6px;color:var(--text2);margin-bottom:8px}
.stat-value{font-size:28px;font-weight:700}
.stat-card.blue   .stat-value{color:#60a5fa}
.stat-card.red    .stat-value{color:#f87171}
.stat-card.yellow .stat-value{color:#fbbf24}
.stat-card.green  .stat-value{color:#4ade80}
.stat-card.purple .stat-value{color:#c084fc}
.stat-icon{position:absolute;top:16px;right:16px;opacity:.2}
.stat-icon svg{width:28px;height:28px}

/* â”€â”€ TABLE â”€â”€ */
.table-card{
  background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;
}
.table-header{
  padding:14px 20px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;
}
.table-title{font-size:14px;font-weight:600}
.table-controls{display:flex;align-items:center;gap:8px}
.search-input{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;color:var(--text);padding:6px 12px;font-size:13px;
  outline:none;width:200px;transition:border-color .2s;
}
.search-input:focus{border-color:var(--blue)}
.filter-select{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;color:var(--text);padding:6px 10px;font-size:13px;
  outline:none;cursor:pointer;
}
.btn-sm{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;color:var(--text);padding:6px 14px;font-size:12px;
  font-weight:600;cursor:pointer;transition:all .15s;
  display:flex;align-items:center;gap:6px;
}
.btn-sm:hover{background:var(--border);border-color:#58a6ff;color:#58a6ff}
.btn-sm.primary{background:var(--blue);border-color:var(--blue);color:#fff}
.btn-sm.primary:hover{background:var(--blue-dark);border-color:var(--blue-dark)}

table{width:100%;border-collapse:collapse}
th{
  padding:10px 16px;text-align:left;font-size:11px;font-weight:700;
  text-transform:uppercase;letter-spacing:.5px;color:var(--text2);
  background:var(--surface2);border-bottom:1px solid var(--border);
}
td{
  padding:12px 16px;border-bottom:1px solid var(--border);
  font-size:13px;vertical-align:middle;
}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(255,255,255,.02)}
.url-cell{max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#58a6ff}
.domain-cell{color:var(--text2);font-size:12px}
.risk-badge{
  display:inline-block;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;text-transform:uppercase;
}
.risk-HIGH        {background:rgba(239,68,68,.15);color:#f87171;border:1px solid rgba(239,68,68,.3)}
.risk-SUSPICIOUS  {background:rgba(245,158,11,.15);color:#fbbf24;border:1px solid rgba(245,158,11,.3)}
.risk-SAFE,.risk-LOW{background:rgba(34,197,94,.15);color:#4ade80;border:1px solid rgba(34,197,94,.3)}
.risk-UNKNOWN     {background:rgba(139,148,158,.15);color:#8b949e;border:1px solid rgba(139,148,158,.3)}
.score-bar{display:flex;align-items:center;gap:8px}
.score-track{flex:1;height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;min-width:60px}
.score-fill{height:100%;border-radius:3px;transition:width .3s}
.score-fill.high   {background:var(--red)}
.score-fill.med    {background:var(--yellow)}
.score-fill.low    {background:var(--green)}
.score-num{font-size:12px;font-weight:600;min-width:26px;text-align:right}
.action-btn{
  background:none;border:1px solid var(--border);border-radius:6px;
  color:var(--text2);padding:4px 10px;font-size:11px;cursor:pointer;
  transition:all .15s;
}
.action-btn:hover{border-color:#58a6ff;color:#58a6ff}

/* pagination */
.pagination{
  padding:12px 20px;border-top:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
}
.page-info{color:var(--text2);font-size:12px}
.page-btns{display:flex;gap:6px}
.page-btn{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:6px;color:var(--text);padding:5px 12px;font-size:12px;cursor:pointer;
  transition:all .15s;
}
.page-btn:hover:not(:disabled){border-color:#58a6ff;color:#58a6ff}
.page-btn:disabled{opacity:.4;cursor:default}
.page-btn.active{background:var(--blue);border-color:var(--blue);color:#fff}

/* â”€â”€ DETAIL MODAL â”€â”€ */
#detailModal{
  position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;
  display:none;align-items:center;justify-content:center;
  backdrop-filter:blur(4px);
}
#detailModal.open{display:flex}
.modal-card{
  background:var(--surface);border:1px solid var(--border);border-radius:16px;
  width:min(820px,95vw);max-height:88vh;overflow-y:auto;
  padding:28px;position:relative;
}
.modal-close{
  position:sticky;top:0;float:right;
  background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;color:var(--text2);padding:4px 10px;cursor:pointer;
  font-size:12px;margin-bottom:12px;
}
.modal-close:hover{color:var(--text)}
.detail-title{font-size:18px;font-weight:700;margin-bottom:20px}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.detail-item{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px}
.detail-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin-bottom:6px}
.detail-value{font-size:14px;font-weight:600;word-break:break-all}
.signal-list{margin-top:6px}
.signal-tag{
  display:inline-block;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.25);
  color:#f87171;font-size:11px;padding:3px 8px;border-radius:5px;margin:3px 3px 0 0;
}
.screenshot-preview{
  width:100%;max-height:300px;object-fit:contain;border-radius:8px;
  border:1px solid var(--border);margin-top:12px;
}
.section-h{font-size:13px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin:20px 0 10px}

/* â”€â”€ HEALTH GRID â”€â”€ */
.health-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;margin-bottom:24px}
.health-card{
  background:var(--surface);border:1px solid var(--border);border-radius:12px;
  padding:16px 18px;display:flex;align-items:center;gap:14px;
}
.health-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0}
.health-dot.connected,.health-dot.available,.health-dot.operational{background:var(--green);box-shadow:0 0 8px var(--green)}
.health-dot.configured{background:var(--blue);box-shadow:0 0 8px var(--blue)}
.health-dot.disconnected,.health-dot.unavailable,.health-dot.error{background:var(--red);box-shadow:0 0 8px var(--red)}
.health-dot.not_configured{background:var(--text3)}
.health-dot.degraded{background:var(--yellow);box-shadow:0 0 8px var(--yellow)}
.health-info .name{font-size:13px;font-weight:600}
.health-info .status{font-size:11px;color:var(--text2);text-transform:capitalize;margin-top:2px}

/* â”€â”€ ANALYTICS â”€â”€ */
.chart-card{
  background:var(--surface);border:1px solid var(--border);border-radius:12px;
  padding:20px;margin-bottom:20px;
}
.chart-title{font-size:14px;font-weight:600;margin-bottom:16px}
.bar-chart{display:flex;flex-direction:column;gap:8px}
.bar-row{display:flex;align-items:center;gap:10px}
.bar-label{width:120px;font-size:12px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:right;flex-shrink:0}
.bar-track{flex:1;height:22px;background:var(--surface2);border-radius:4px;overflow:hidden}
.bar-fill{height:100%;border-radius:4px;transition:width .5s;display:flex;align-items:center;justify-content:flex-end;padding-right:8px}
.bar-fill.blue  {background:linear-gradient(90deg,rgba(37,99,235,.6),rgba(37,99,235,.9))}
.bar-fill.red   {background:linear-gradient(90deg,rgba(239,68,68,.6),rgba(239,68,68,.9))}
.bar-fill.yellow{background:linear-gradient(90deg,rgba(245,158,11,.6),rgba(245,158,11,.9))}
.bar-fill.green {background:linear-gradient(90deg,rgba(34,197,94,.6),rgba(34,197,94,.9))}
.bar-count{font-size:11px;font-weight:700;color:#fff}
.bar-count-out{font-size:12px;font-weight:600;color:var(--text2);width:40px}
.mini-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}

/* â”€â”€ LOG TABLE â”€â”€ */
.log-action{font-size:11px;font-weight:700;padding:2px 8px;border-radius:4px;text-transform:uppercase;letter-spacing:.3px}
.log-LOGIN   {background:rgba(34,197,94,.15);color:#4ade80}
.log-LOGOUT  {background:rgba(139,148,158,.15);color:#8b949e}
.log-VIEW_DASHBOARD,.log-VIEW_SCAN,.log-VIEW_REPORTS,.log-VIEW_ANALYTICS{background:rgba(37,99,235,.15);color:#60a5fa}
.log-EXPORT_SCANS{background:rgba(168,85,247,.15);color:#c084fc}

/* â”€â”€ LOADING / EMPTY â”€â”€ */
.loading-state,.empty-state{
  padding:48px;text-align:center;color:var(--text2);
}
.loading-spinner{
  width:32px;height:32px;margin:0 auto 12px;
  border:3px solid var(--border);border-top-color:var(--blue);
  border-radius:50%;animation:spin .7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ SCREENSHOT GRID â”€â”€ */
.ss-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;padding:20px}
.ss-card{
  background:var(--surface2);border:1px solid var(--border);border-radius:10px;overflow:hidden;
  transition:border-color .2s;cursor:pointer;
}
.ss-card:hover{border-color:#58a6ff}
.ss-card img{width:100%;height:120px;object-fit:cover}
.ss-info{padding:8px 10px}
.ss-name{font-size:11px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ss-date{font-size:10px;color:var(--text3);margin-top:2px}

.toast{
  position:fixed;bottom:24px;right:24px;
  background:var(--surface2);border:1px solid var(--border);
  color:var(--text);border-radius:10px;padding:12px 18px;
  font-size:13px;box-shadow:0 8px 32px rgba(0,0,0,.4);
  transform:translateY(80px);opacity:0;transition:all .3s;z-index:9999;
}
.toast.show{transform:translateY(0);opacity:1}

@media(max-width:768px){
  #sidebar{display:none}
  .detail-grid{grid-template-columns:1fr}
  .mini-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-logo">
      <div class="logo-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
          <polyline points="9 12 11 14 15 10"/>
        </svg>
      </div>
      <div>
        <div class="logo-text">PhishGuard</div>
        <div class="logo-sub">Admin Console</div>
      </div>
    </div>
    <div class="admin-badge">Secure Panel</div>
  </div>

  <nav>
    <div class="nav-section">Overview</div>
    <div class="nav-item active" data-panel="dashboard" onclick="switchPanel('dashboard',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
      Dashboard
    </div>
    <div class="nav-item" data-panel="analytics" onclick="switchPanel('analytics',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      Analytics
    </div>

    <div class="nav-section">Detection</div>
    <div class="nav-item" data-panel="scans" onclick="switchPanel('scans',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      Scan History
    </div>
    <div class="nav-item" data-panel="domains" onclick="switchPanel('domains',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>
      Domains
    </div>
    <div class="nav-item" data-panel="reports" onclick="switchPanel('reports',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      User Reports
    </div>
    <div class="nav-item" data-panel="screenshots" onclick="switchPanel('screenshots',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
      Screenshots
    </div>

    <div class="nav-section" id="superAdminNav" style="display:none">Super Admin</div>
    <div class="nav-item" id="navManageAdmins" data-panel="manage-admins" onclick="switchPanel('manage-admins',this)" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
      Manage Admins
      <span class="badge-count" id="adminCount"></span>
    </div>
    <div class="nav-item" id="navApiControl" data-panel="api-control" onclick="switchPanel('api-control',this)" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg>
      API Control
    </div>

    <div class="nav-section">System</div>
    <div class="nav-item" data-panel="health" onclick="switchPanel('health',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      System Health
    </div>
    <div class="nav-item" data-panel="logs" onclick="switchPanel('logs',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12h6M9 16h6M9 8h6M5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2z"/></svg>
      Activity Logs
    </div>
  </nav>

  <div class="sidebar-footer">
    <button class="logout-btn" onclick="doLogout()">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      Sign Out
    </button>
  </div>
</aside>

<!-- MAIN -->
<div id="main">
  <div class="topbar">
    <div class="page-title" id="pageTitle">Dashboard</div>
    <div class="topbar-right">
      <div class="status-dot" title="System online"></div>
      <div class="admin-chip">
        <div class="admin-avatar" id="adminAvatar">A</div>
        <span id="adminName">Admin</span>
      </div>
    </div>
  </div>

  <div id="content">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel active" id="panel-dashboard">
      <div class="stats-grid" id="statsGrid">
        <div class="loading-state" style="grid-column:1/-1"><div class="loading-spinner"></div>Loading...</div>
      </div>
      <div class="table-card">
        <div class="table-header">
          <div class="table-title">Recent Activity</div>
          <button class="btn-sm" onclick="loadDashboard()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
            Refresh
          </button>
        </div>
        <table>
          <thead><tr><th>URL</th><th>Domain</th><th>Risk</th><th>Score</th><th>Time</th></tr></thead>
          <tbody id="recentTbody"><tr><td colspan="5" class="loading-state">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCAN HISTORY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-scans">
      <div class="table-card">
        <div class="table-header">
          <div class="table-title">URL Scan History</div>
          <div class="table-controls">
            <input type="text" class="search-input" id="scanSearch" placeholder="Search URL or domainâ€¦" oninput="debounce(loadScans,400)()"/>
            <select class="filter-select" id="scanRisk" onchange="loadScans()">
              <option value="">All Risks</option>
              <option value="HIGH">High</option>
              <option value="SUSPICIOUS">Suspicious</option>
              <option value="SAFE">Safe</option>
            </select>
            <button class="btn-sm" onclick="exportScans()">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Export CSV
            </button>
          </div>
        </div>
        <table>
          <thead><tr><th>URL</th><th>Domain</th><th>Risk</th><th>Score</th><th>Timestamp</th><th>Action</th></tr></thead>
          <tbody id="scansTbody"><tr><td colspan="6" class="loading-state">Loading...</td></tr></tbody>
        </table>
        <div class="pagination">
          <div class="page-info" id="scansPageInfo">â€“</div>
          <div class="page-btns">
            <button class="page-btn" id="scansPrev" onclick="scansPage('prev')">â† Prev</button>
            <button class="page-btn" id="scansNext" onclick="scansPage('next')">Next â†’</button>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DOMAINS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-domains">
      <div class="table-card">
        <div class="table-header">
          <div class="table-title">Domain Reputation Tracking</div>
          <div class="table-controls">
            <input type="text" class="search-input" id="domainSearch" placeholder="Search domainâ€¦" oninput="debounce(loadDomains,400)()"/>
          </div>
        </div>
        <table>
          <thead><tr><th>Domain</th><th>First Seen</th><th>Last Scanned</th><th>Total Scans</th><th>Phishing Count</th><th>Avg Score</th><th>BL Hits</th></tr></thead>
          <tbody id="domainsTbody"><tr><td colspan="7" class="loading-state">Loading...</td></tr></tbody>
        </table>
        <div class="pagination">
          <div class="page-info" id="domainsPageInfo">â€“</div>
          <div class="page-btns">
            <button class="page-btn" id="domainsPrev" onclick="domainsPage('prev')">â† Prev</button>
            <button class="page-btn" id="domainsNext" onclick="domainsPage('next')">Next â†’</button>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• USER REPORTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-reports">
      <div class="table-card">
        <div class="table-header">
          <div class="table-title">Community User Reports</div>
        </div>
        <table>
          <thead><tr><th>URL</th><th>Type</th><th>Count</th><th>Last Reported</th><th>Reporter (hashed)</th></tr></thead>
          <tbody id="reportsTbody"><tr><td colspan="5" class="loading-state">Loading...</td></tr></tbody>
        </table>
        <div class="pagination">
          <div class="page-info" id="reportsPageInfo">â€“</div>
          <div class="page-btns">
            <button class="page-btn" id="reportsPrev" onclick="reportsPage('prev')">â† Prev</button>
            <button class="page-btn" id="reportsNext" onclick="reportsPage('next')">Next â†’</button>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCREENSHOTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-screenshots">
      <div class="table-card">
        <div class="table-header">
          <div class="table-title">Screenshot Monitoring</div>
          <div class="table-controls">
            <span id="ssCount" class="page-info"></span>
          </div>
        </div>
        <div class="ss-grid" id="ssGrid"><div class="loading-state" style="grid-column:1/-1"><div class="loading-spinner"></div>Loading...</div></div>
        <div class="pagination">
          <div class="page-info" id="ssPageInfo">â€“</div>
          <div class="page-btns">
            <button class="page-btn" id="ssPrev" onclick="ssPage('prev')">â† Prev</button>
            <button class="page-btn" id="ssNext" onclick="ssPage('next')">Next â†’</button>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEALTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-health">
      <div class="health-grid" id="healthGrid">
        <div class="loading-state"><div class="loading-spinner"></div></div>
      </div>
      <div class="table-card">
        <div class="table-header">
          <div class="table-title">API Configuration Status</div>
          <button class="btn-sm" onclick="loadHealth()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
            Refresh
          </button>
        </div>
        <table>
          <thead><tr><th>Component</th><th>Status</th><th>Details</th></tr></thead>
          <tbody id="healthTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ANALYTICS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-analytics">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div></div>
        <select class="filter-select" id="analyticsDays" onchange="loadAnalytics()">
          <option value="7">Last 7 days</option>
          <option value="14">Last 14 days</option>
          <option value="30">Last 30 days</option>
        </select>
      </div>
      <div class="mini-grid">
        <div class="chart-card">
          <div class="chart-title">Daily Scan Volume</div>
          <div class="bar-chart" id="dailyChart"><div class="loading-state"><div class="loading-spinner"></div></div></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Risk Distribution</div>
          <div class="bar-chart" id="riskChart"><div class="loading-state"><div class="loading-spinner"></div></div></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Top Scanned Domains</div>
          <div class="bar-chart" id="topDomainsChart"><div class="loading-state"><div class="loading-spinner"></div></div></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Most Reported URLs</div>
          <div class="bar-chart" id="topReportedChart"><div class="loading-state"><div class="loading-spinner"></div></div></div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-logs">
      <div class="table-card">
        <div class="table-header">
          <div class="table-title">Admin Activity Logs</div>
          <button class="btn-sm" onclick="loadLogs()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
            Refresh
          </button>
        </div>
        <table>
          <thead><tr><th>Admin</th><th>Action</th><th>Details</th><th>IP Address</th><th>Timestamp</th></tr></thead>
          <tbody id="logsTbody"><tr><td colspan="5" class="loading-state">Loading...</td></tr></tbody>
        </table>
        <div class="pagination">
          <div class="page-info" id="logsPageInfo">â€“</div>
          <div class="page-btns">
            <button class="page-btn" id="logsPrev" onclick="logsPage('prev')">â† Prev</button>
            <button class="page-btn" id="logsNext" onclick="logsPage('next')">Next â†’</button>
          </div>
        </div>
      </div>
    </div>


    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MANAGE ADMINS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-manage-admins">
      <div class="table-card">
        <div class="table-header">
          <div class="table-title">Admin User Management (Max: 1 Super Admin + 4 Regular Admins)</div>
          <button class="btn-sm primary" onclick="showCreateAdminModal()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add Admin
          </button>
        </div>
        <table>
          <thead><tr><th>Username</th><th>Role</th><th>Created</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="adminsTbody"><tr><td colspan="5" class="loading-state">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• API CONTROL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel" id="panel-api-control">
      <div class="stats-grid" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr))">
        <div class="stat-card blue">
          <div class="stat-label">Total API Calls</div>
          <div class="stat-value" id="totalApiCalls">0</div>
        </div>
      </div>
      
      <div class="table-card" style="margin-top:20px">
        <div class="table-header">
          <div class="table-title">API Services Control</div>
          <button class="btn-sm" onclick="resetApiCounters()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
            Reset Counters
          </button>
        </div>
        <table>
          <thead><tr><th>API Service</th><th>Status</th><th>Usage Count</th><th>Last Used</th><th>Action</th></tr></thead>
          <tbody id="apiControlTbody"><tr><td colspan="5" class="loading-state">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>


  </div><!-- /content -->
</div><!-- /main -->

<!-- â”€â”€ DETAIL MODAL â”€â”€ -->
<div id="detailModal">
  <div class="modal-card" id="modalCard">
    <button class="modal-close" onclick="closeModal()">âœ• Close</button>
    <div id="modalBody"></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â•â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let scansState   = {page:1,total:0};
let domainsState = {page:1,total:0};
let reportsState = {page:1,total:0};
let ssState      = {page:1,total:0};
let logsState    = {page:1,total:0};
const PER_PAGE   = 25;

// â•â•â• BOOTSTRAP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', async () => {
  try {
    const res  = await fetch('/admin/api/me');
    const data = await res.json();
    if (!data.logged_in) { window.location.href='/admin/login'; return; }
    const u = data.username || 'Admin';
    document.getElementById('adminName').textContent = u;
    document.getElementById('adminAvatar').textContent = u[0].toUpperCase();
    
    // Show super admin menu items if super admin
    if (sessionStorage.getItem('admin_role') === 'super_admin') {
      document.getElementById('superAdminNav').style.display = 'block';
      document.getElementById('navManageAdmins').style.display = 'flex';
      document.getElementById('navApiControl').style.display = 'flex';
    }
  } catch(e) { window.location.href='/admin/login'; return; }
  loadDashboard();
});

// â•â•â• NAVIGATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PANEL_TITLES = {
  dashboard:'Dashboard', analytics:'Analytics', scans:'Scan History',
  domains:'Domain Reputation', reports:'User Reports', screenshots:'Screenshots',
  health:'System Health', logs:'Activity Logs',
  'manage-admins':'Manage Admins', 'api-control':'API Control'
};
function switchPanel(name, el) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
  document.getElementById('panel-'+name).classList.add('active');
  el.classList.add('active');
  document.getElementById('pageTitle').textContent = PANEL_TITLES[name] || name;
  const loaders = {
    dashboard: loadDashboard, analytics: loadAnalytics,
    scans: loadScans, domains: loadDomains,
    reports: loadReports, screenshots: loadScreenshots,
    health: loadHealth, logs: loadLogs
  };
  if (loaders[name]) loaders[name]();
}

// â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogout() {
  await fetch('/admin/api/logout', {method:'POST'});
  window.location.href = '/admin/login';
}

// â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDashboard() {
  document.getElementById('statsGrid').innerHTML =
    `<div class="loading-state" style="grid-column:1/-1"><div class="loading-spinner"></div>Loading...</div>`;
  try {
    const data = await apiFetch('/admin/api/dashboard');
    renderStats(data);
    renderRecent(data.recent_activity || []);
  } catch(e) { showToast('Error loading dashboard'); }
}

function renderStats(d) {
  const cards = [
    {label:'Total Scans',    value:d.total_scans,    cls:'blue',   icon:'<circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>'},
    {label:'High Risk',      value:d.high_risk,      cls:'red',    icon:'<path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>'},
    {label:'Suspicious',     value:d.suspicious,     cls:'yellow', icon:'<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>'},
    {label:'Safe',           value:d.safe,           cls:'green',  icon:'<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><polyline points="9 12 11 14 15 10"/>'},
    {label:'User Reports',   value:d.total_reports,  cls:'purple', icon:'<path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/>'}
  ];
  document.getElementById('statsGrid').innerHTML = cards.map(c => `
    <div class="stat-card ${c.cls}">
      <div class="stat-label">${c.label}</div>
      <div class="stat-value">${(c.value||0).toLocaleString()}</div>
      <div class="stat-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${c.icon}</svg>
      </div>
    </div>`).join('');
}

function renderRecent(rows) {
  if (!rows.length) { document.getElementById('recentTbody').innerHTML = `<tr><td colspan="5" class="empty-state">No recent scans</td></tr>`; return; }
  document.getElementById('recentTbody').innerHTML = rows.map(r => `
    <tr>
      <td class="url-cell" title="${esc(r.url)}">${esc(r.url)}</td>
      <td class="domain-cell">${esc(r.domain||'â€“')}</td>
      <td><span class="risk-badge risk-${r.risk_level}">${r.risk_level}</span></td>
      <td>${scoreBar(r.risk_score)}</td>
      <td style="color:var(--text2);font-size:12px">${fmtDate(r.timestamp)}</td>
    </tr>`).join('');
}

// â•â•â• SCANS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadScans() {
  scansState.page = 1;
  await fetchScans();
}
async function fetchScans() {
  const tbody = document.getElementById('scansTbody');
  tbody.innerHTML = `<tr><td colspan="6" class="loading-state"><div class="loading-spinner" style="margin:0 auto 8px"></div>Loading...</td></tr>`;
  const q   = document.getElementById('scanSearch').value;
  const r   = document.getElementById('scanRisk').value;
  const url = `/admin/api/scans?page=${scansState.page}&per_page=${PER_PAGE}&q=${encodeURIComponent(q)}&risk=${r}`;
  try {
    const data = await apiFetch(url);
    scansState.total = data.total || 0;
    if (!data.scans?.length) { tbody.innerHTML = `<tr><td colspan="6" class="empty-state">No scans found</td></tr>`; updatePager('scans',0); return; }
    tbody.innerHTML = data.scans.map(s => `
      <tr>
        <td class="url-cell" title="${esc(s.url)}">${esc(s.url)}</td>
        <td class="domain-cell">${esc(s.domain||'â€“')}</td>
        <td><span class="risk-badge risk-${s.risk_level}">${s.risk_level}</span></td>
        <td>${scoreBar(s.risk_score)}</td>
        <td style="color:var(--text2);font-size:12px">${fmtDate(s.timestamp)}</td>
        <td><button class="action-btn" onclick="viewScan('${s.id}')">Details</button></td>
      </tr>`).join('');
    updatePager('scans', data.total);
  } catch(e) { tbody.innerHTML=`<tr><td colspan="6" class="empty-state">Error loading data</td></tr>`; }
}
function scansPage(dir) { paginate(dir, scansState, fetchScans); }
function exportScans() {
  const r = document.getElementById('scanRisk').value;
  window.open(`/admin/api/export/scans?risk=${r}`, '_blank');
}

// â•â•â• SCAN DETAIL MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function viewScan(id) {
  openModal('<div class="loading-state"><div class="loading-spinner"></div>Loading detailsâ€¦</div>');
  try {
    const data = await apiFetch(`/admin/api/scans/${id}`);
    const a = data.analysis || {};
    const signals = a.triggered_rules || a.heuristic_signals || [];
    const ssl = a.ssl_info || a.ssl_certificate || {};
    const whois_data = a.whois_info || a.domain_info || {};
    const blacklist = a.blacklist_results || a.external_checks || {};

    let ssHtml = '';
    if (a.screenshot_url || a.thumbnail_url) {
      ssHtml = `<div class="section-h">Screenshot</div>
        <img src="${a.screenshot_url||a.thumbnail_url}" class="screenshot-preview" alt="Screenshot" onerror="this.style.display='none'"/>`;
    }

    document.getElementById('modalBody').innerHTML = `
      <div class="detail-title">ğŸ” Scan Detail</div>
      <div style="word-break:break-all;color:#58a6ff;margin-bottom:16px;font-size:13px">${esc(a.url||id)}</div>
      <div class="detail-grid">
        <div class="detail-item">
          <div class="detail-label">Verdict</div>
          <div class="detail-value"><span class="risk-badge risk-${a.risk_level||'UNKNOWN'}">${a.risk_level||'N/A'}</span></div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Risk Score</div>
          <div class="detail-value">${scoreBar(a.risk_score)}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Confidence</div>
          <div class="detail-value">${a.confidence_score ?? a.confidence ?? 'â€“'}${a.confidence_score != null ? '%' : ''}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Domain</div>
          <div class="detail-value">${esc(a.domain||'â€“')}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">SSL Valid</div>
          <div class="detail-value">${ssl.valid!=null?(ssl.valid?'âœ… Valid':'âŒ Invalid'):esc(ssl.issuer||'â€“')}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Domain Age</div>
          <div class="detail-value">${esc(a.domain_age_days!=null?a.domain_age_days+' days':(whois_data.creation_date||'â€“'))}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Registrar</div>
          <div class="detail-value">${esc(whois_data.registrar||ssl.organization||'â€“')}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Blacklist Hits</div>
          <div class="detail-value">${esc(JSON.stringify(blacklist).replace(/[{}]/g,'').replace(/"/g,'').substring(0,60)||'â€“')}</div>
        </div>
      </div>
      ${signals.length ? `
        <div class="section-h">Heuristic Signals Triggered (${signals.length})</div>
        <div class="signal-list">${signals.map(s=>`<span class="signal-tag">${esc(s)}</span>`).join('')}</div>` : ''}
      <div class="section-h">Action Guidance</div>
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;font-size:13px;color:var(--text2)">
        ${esc(a.recommendation || a.action || (a.risk_level==='HIGH'?'âš ï¸ Block and warn user immediately':(a.risk_level==='SUSPICIOUS'?'âš ï¸ Proceed with caution':'âœ… Appears safe to visit')))}
      </div>
      ${ssHtml}
    `;
  } catch(e) {
    document.getElementById('modalBody').innerHTML = `<div class="empty-state">Failed to load scan details</div>`;
  }
}

// â•â•â• DOMAINS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDomains() { domainsState.page=1; await fetchDomains(); }
async function fetchDomains() {
  const tbody = document.getElementById('domainsTbody');
  tbody.innerHTML = `<tr><td colspan="7" class="loading-state"><div class="loading-spinner" style="margin:0 auto 8px"></div></td></tr>`;
  const q = document.getElementById('domainSearch').value;
  try {
    const data = await apiFetch(`/admin/api/domains?page=${domainsState.page}&per_page=${PER_PAGE}&q=${encodeURIComponent(q)}`);
    if (!data.domains?.length) { tbody.innerHTML=`<tr><td colspan="7" class="empty-state">No domains found</td></tr>`; updatePager('domains',0); return; }
    tbody.innerHTML = data.domains.map(d => {
      const phishCls = d.phishing_count > 3 ? 'color:var(--red);font-weight:700' : d.phishing_count > 0 ? 'color:var(--yellow)' : 'color:var(--green)';
      return `<tr>
        <td style="font-weight:600;color:#58a6ff">${esc(d.domain)}</td>
        <td style="color:var(--text2);font-size:12px">${fmtDateShort(d.first_seen)}</td>
        <td style="color:var(--text2);font-size:12px">${fmtDateShort(d.last_scanned)}</td>
        <td style="font-weight:600">${d.total_scans}</td>
        <td><span style="${phishCls}">${d.phishing_count}</span></td>
        <td>${scoreBar(d.avg_risk_score)}</td>
        <td style="font-weight:600;color:${d.blacklist_hits>0?'var(--red)':'var(--green)'}">${d.blacklist_hits}</td>
      </tr>`;}).join('');
    updatePager('domains', data.total);
  } catch(e) { tbody.innerHTML=`<tr><td colspan="7" class="empty-state">Error loading data</td></tr>`; }
}
function domainsPage(dir) { paginate(dir, domainsState, fetchDomains); }

// â•â•â• REPORTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadReports() { reportsState.page=1; await fetchReports(); }
async function fetchReports() {
  const tbody = document.getElementById('reportsTbody');
  tbody.innerHTML = `<tr><td colspan="5" class="loading-state"><div class="loading-spinner" style="margin:0 auto 8px"></div></td></tr>`;
  try {
    const data = await apiFetch(`/admin/api/reports?page=${reportsState.page}&per_page=${PER_PAGE}`);
    if (!data.reports?.length) { tbody.innerHTML=`<tr><td colspan="5" class="empty-state">No reports found</td></tr>`; updatePager('reports',0); return; }
    const typeColors = {phishing:'risk-HIGH', safe:'risk-SAFE', false_positive:'risk-SUSPICIOUS'};
    tbody.innerHTML = data.reports.map(r => `
      <tr>
        <td class="url-cell" title="${esc(r.url)}">${esc(r.url)}</td>
        <td><span class="risk-badge ${typeColors[r.report_type]||'risk-UNKNOWN'}">${esc(r.report_type)}</span></td>
        <td style="font-weight:700">${r.report_count}</td>
        <td style="color:var(--text2);font-size:12px">${fmtDate(r.last_reported)}</td>
        <td style="color:var(--text3);font-family:monospace;font-size:12px">${esc(r.reporter_ip||'â€“')}</td>
      </tr>`).join('');
    updatePager('reports', data.total);
  } catch(e) { tbody.innerHTML=`<tr><td colspan="5" class="empty-state">Error loading data</td></tr>`; }
}
function reportsPage(dir) { paginate(dir, reportsState, fetchReports); }

// â•â•â• SCREENSHOTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadScreenshots() { ssState.page=1; await fetchScreenshots(); }
async function fetchScreenshots() {
  const grid = document.getElementById('ssGrid');
  grid.innerHTML = `<div class="loading-state" style="grid-column:1/-1"><div class="loading-spinner"></div></div>`;
  try {
    const data = await apiFetch(`/admin/api/screenshots?page=${ssState.page}&per_page=12`);
    if (!data.screenshots?.length) { grid.innerHTML=`<div class="empty-state" style="grid-column:1/-1">No screenshots found</div>`; updatePager('ss',0); return; }
    document.getElementById('ssCount').textContent = `${data.total} total`;
    grid.innerHTML = data.screenshots.map(s => `
      <div class="ss-card" onclick="viewScreenshot('${s.url}')">
        <img src="${s.url}" alt="${esc(s.filename)}" onerror="this.src='/screenshots/placeholder.png';this.onerror=null" loading="lazy"/>
        <div class="ss-info">
          <div class="ss-name">${esc(s.filename)}</div>
          <div class="ss-date">${fmtDate(s.timestamp)} Â· ${s.size_kb} KB</div>
        </div>
      </div>`).join('');
    updatePager('ss', data.total);
  } catch(e) { grid.innerHTML=`<div class="empty-state" style="grid-column:1/-1">Error loading screenshots</div>`; }
}
function ssPage(dir) { paginate(dir, ssState, fetchScreenshots, 12); }
function viewScreenshot(url) {
  openModal(`<img src="${url}" style="max-width:100%;border-radius:8px;display:block;margin:0 auto" alt="Screenshot"/>`);
}

// â•â•â• HEALTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadHealth() {
  document.getElementById('healthGrid').innerHTML = `<div class="loading-state"><div class="loading-spinner"></div></div>`;
  try {
    const data = await apiFetch('/admin/api/health');
    const c = data.components || {};
    const components = [
      {name:'MongoDB Database',      key:'database',            icon:'ğŸ—„ï¸'},
      {name:'Screenshot Storage',    key:'screenshots',         icon:'ğŸ“¸'},
      {name:'Google Safe Browsing',  key:'google_safe_browsing',icon:'ğŸ”'},
      {name:'VirusTotal API',        key:'virustotal',          icon:'ğŸ¦ '},
      {name:'WHOIS Service',         key:'whois',               icon:'ğŸŒ'},
      {name:'Screenshot Service',    key:'screenshot_service',  icon:'ğŸ“·'}
    ];
    document.getElementById('healthGrid').innerHTML = components.map(comp => `
      <div class="health-card">
        <div class="health-dot ${(c[comp.key]||'unknown').replace(/_/g,'-')} ${c[comp.key]||''}"></div>
        <div class="health-info">
          <div class="name">${comp.icon} ${comp.name}</div>
          <div class="status">${(c[comp.key]||'unknown').replace(/_/g,' ')}</div>
        </div>
      </div>`).join('');
    document.getElementById('healthTbody').innerHTML = components.map(comp => {
      const st = c[comp.key] || 'unknown';
      const color = {connected:'var(--green)',available:'var(--green)',operational:'var(--green)',
                     configured:'var(--blue)',disconnected:'var(--red)',unavailable:'var(--red)',
                     error:'var(--red)',not_configured:'var(--text3)',degraded:'var(--yellow)'}[st]||'var(--text2)';
      return `<tr>
        <td><b>${comp.icon} ${comp.name}</b></td>
        <td><span style="color:${color};font-weight:600;text-transform:capitalize">${st.replace(/_/g,' ')}</span></td>
        <td style="color:var(--text2);font-size:12px">${describeStatus(comp.key,st)}</td>
      </tr>`;}).join('');
  } catch(e) { document.getElementById('healthGrid').innerHTML=`<div class="empty-state">Error loading health data</div>`; }
}
function describeStatus(key,st){
  const map = {
    connected:'Active database connection',available:'Directory accessible',
    configured:'API key is set in environment',not_configured:'API key not configured â€“ feature disabled',
    disconnected:'Cannot reach database',unavailable:'Storage path not found',
    error:'Connection error',degraded:'Service running but with issues'
  };
  return map[st]||st;
}

// â•â•â• ANALYTICS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAnalytics() {
  ['dailyChart','riskChart','topDomainsChart','topReportedChart'].forEach(id => {
    document.getElementById(id).innerHTML = `<div class="loading-state"><div class="loading-spinner"></div></div>`;
  });
  const days = document.getElementById('analyticsDays').value;
  try {
    const data = await apiFetch(`/admin/api/analytics?days=${days}`);
    renderBarChart('dailyChart', (data.daily_scans||[]).map(d=>({label:d.date.slice(5),val:d.count,cls:'blue'})), 'Scans per day');
    const riskOrder = ['HIGH','SUSPICIOUS','SAFE','LOW','UNKNOWN'];
    const riskColors = {HIGH:'red',SUSPICIOUS:'yellow',SAFE:'green',LOW:'green',UNKNOWN:'blue'};
    renderBarChart('riskChart',
      (data.risk_distribution||[]).sort((a,b)=>riskOrder.indexOf(a.level)-riskOrder.indexOf(b.level))
        .map(d=>({label:d.level,val:d.count,cls:riskColors[d.level]||'blue'})));
    renderBarChart('topDomainsChart', (data.top_domains||[]).slice(0,8).map(d=>({label:d.domain,val:d.count,cls:'blue'})));
    renderBarChart('topReportedChart', (data.top_reported||[]).slice(0,8).map(d=>({label:d.url.split('/')[2]||d.url,val:d.count,cls:'red'})));
  } catch(e) {
    ['dailyChart','riskChart','topDomainsChart','topReportedChart'].forEach(id => {
      document.getElementById(id).innerHTML=`<div class="empty-state">Error loading data</div>`;
    });
  }
}
function renderBarChart(elId, rows, subtitle='') {
  const el = document.getElementById(elId);
  if (!rows.length) { el.innerHTML=`<div class="empty-state">No data available</div>`; return; }
  const max = Math.max(...rows.map(r=>r.val), 1);
  el.innerHTML = rows.map(r => {
    const pct = Math.max(4, Math.round((r.val/max)*100));
    return `<div class="bar-row">
      <div class="bar-label" title="${esc(r.label)}">${esc(r.label)}</div>
      <div class="bar-track">
        <div class="bar-fill ${r.cls||'blue'}" style="width:${pct}%">
          ${pct>20?`<span class="bar-count">${r.val}</span>`:''}
        </div>
      </div>
      ${pct<=20?`<span class="bar-count-out">${r.val}</span>`:''}
    </div>`;}).join('');
}

// â•â•â• LOGS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadLogs() { logsState.page=1; await fetchLogs(); }
async function fetchLogs() {
  const tbody = document.getElementById('logsTbody');
  tbody.innerHTML = `<tr><td colspan="5" class="loading-state"><div class="loading-spinner" style="margin:0 auto 8px"></div></td></tr>`;
  try {
    const data = await apiFetch(`/admin/api/logs?page=${logsState.page}&per_page=${PER_PAGE}`);
    if (!data.logs?.length) { tbody.innerHTML=`<tr><td colspan="5" class="empty-state">No logs found</td></tr>`; updatePager('logs',0); return; }
    tbody.innerHTML = data.logs.map(l => `
      <tr>
        <td style="font-weight:600">${esc(l.admin)}</td>
        <td><span class="log-action log-${l.action}">${esc(l.action)}</span></td>
        <td style="color:var(--text2);font-size:12px">${esc(l.details||'â€“')}</td>
        <td style="color:var(--text3);font-family:monospace;font-size:12px">${esc(l.ip||'â€“')}</td>
        <td style="color:var(--text2);font-size:12px">${fmtDate(l.timestamp)}</td>
      </tr>`).join('');
    updatePager('logs', data.total);
  } catch(e) { tbody.innerHTML=`<tr><td colspan="5" class="empty-state">Error loading logs</td></tr>`; }
}
function logsPage(dir) { paginate(dir, logsState, fetchLogs); }

// â•â•â• UTILITIES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function apiFetch(url) {
  const res = await fetch(url);
  if (res.status === 401) { window.location.href='/admin/login'; throw new Error('Unauthorized'); }
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

function scoreBar(score) {
  const s = Math.round(score||0);
  const cls = s>=70?'high':s>=40?'med':'low';
  const color = s>=70?'var(--red)':s>=40?'var(--yellow)':'var(--green)';
  return `<div class="score-bar">
    <div class="score-track"><div class="score-fill ${cls}" style="width:${s}%"></div></div>
    <span class="score-num" style="color:${color}">${s}</span>
  </div>`;
}

function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function fmtDate(ts) {
  if (!ts) return 'â€“';
  try {
    return new Date(ts).toLocaleString(undefined,{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
  } catch(e){ return ts; }
}
function fmtDateShort(ts) {
  if (!ts) return 'â€“';
  try { return new Date(ts).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}); }
  catch(e){ return ts; }
}

function updatePager(key, total) {
  const stateMap = {scans:scansState,domains:domainsState,reports:reportsState,ss:ssState,logs:logsState};
  const st  = stateMap[key];
  const pp  = key==='ss'?12:PER_PAGE;
  const pages = Math.ceil(total/pp) || 1;
  const info  = document.getElementById(key+'PageInfo');
  if (info) info.textContent = `Page ${st.page} of ${pages} Â· ${total.toLocaleString()} records`;
  const prev = document.getElementById(key+'Prev');
  const next = document.getElementById(key+'Next');
  if (prev) prev.disabled = st.page <= 1;
  if (next) next.disabled = st.page >= pages;
}

function paginate(dir, state, fetcher, pp=PER_PAGE) {
  const pages = Math.ceil(state.total/pp)||1;
  if (dir==='prev' && state.page>1) state.page--;
  else if (dir==='next' && state.page<pages) state.page++;
  fetcher();
}

let debounceTimer;
function debounce(fn, delay) {
  return function() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(fn, delay);
  };
}

function openModal(html) {
  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('detailModal').classList.add('open');
}
function closeModal() {
  document.getElementById('detailModal').classList.remove('open');
}
document.getElementById('detailModal').addEventListener('click', e => {
  if (e.target === document.getElementById('detailModal')) closeModal();
});

function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 3000);
}


// â•â•â• SUPER ADMIN FEATURES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// (Auth check moved to main DOMContentLoaded above)

// Update switchPanel to add super admin panels
const originalSwitchPanel = switchPanel;
switchPanel = function(name, el) {
  originalSwitchPanel(name, el);
  if (name === 'manage-admins') loadManageAdmins();
  if (name === 'api-control') loadApiControl();
};

// Load manage admins
async function loadManageAdmins() {
  const tbody = document.getElementById('adminsTbody');
  tbody.innerHTML = '<tr><td colspan="5" class="loading-state"><div class="loading-spinner"></div></td></tr>';
  
  try {
    const data = await apiFetch('/admin/api/super/admins');
    if (!data.admins?.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No admins</td></tr>';
      return;
    }
    
    tbody.innerHTML = data.admins.map(a => {
      const isSuperAdmin = a.role === 'super_admin';
      const statusColor = a.active ? 'var(--green)' : 'var(--red)';
      const statusText = a.active ? 'Active' : 'Disabled';
      
      return `<tr>
        <td style="font-weight:600">${esc(a.username)}</td>
        <td><span class="risk-badge ${isSuperAdmin?'risk-HIGH':'risk-SAFE'}">${isSuperAdmin?'SUPER ADMIN':'ADMIN'}</span></td>
        <td style="color:var(--text2);font-size:12px">${fmtDateShort(a.created_at)}</td>
        <td><span style="color:${statusColor};font-weight:600">${statusText}</span></td>
        <td>
          ${!isSuperAdmin ? `
            <button class="action-btn" onclick="toggleAdmin('${esc(a.username)}')" style="margin-right:6px">
              ${a.active?'Disable':'Enable'}
            </button>
            <button class="action-btn" onclick="deleteAdmin('${esc(a.username)')}" style="border-color:var(--red);color:var(--red)">
              Delete
            </button>
          ` : '<span style="color:var(--text3);font-size:12px">Protected</span>'}
        </td>
      </tr>`;
    }).join('');
    
    document.getElementById('adminCount').textContent = data.admins.filter(a=>a.role==='admin').length + '/4';
  } catch(e) {
    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Error loading admins</td></tr>';
  }
}

function showCreateAdminModal() {
  const username = prompt('Enter new admin username (3+ chars):');
  if (!username || username.length < 3) return;
  
  const password = prompt('Enter password (6+ chars):');
  if (!password || password.length < 6) {
    alert('Password must be at least 6 characters');
    return;
  }
  
  createAdmin(username, password);
}

async function createAdmin(username, password) {
  try {
    const res = await fetch('/admin/api/super/admins', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({username, password})
    });
    const data = await res.json();
    
    if (data.success) {
      showToast('Admin created successfully');
      loadManageAdmins();
    } else {
      alert('Error: ' + (data.error || 'Failed to create admin'));
    }
  } catch(e) {
    alert('Error creating admin');
  }
}

async function toggleAdmin(username) {
  if (!confirm(`Toggle status for ${username}?`)) return;
  
  try {
    const res = await fetch(`/admin/api/super/admins/${encodeURIComponent(username)}/toggle`, {method:'POST'});
    const data = await res.json();
    
    if (data.success) {
      showToast(`Admin ${data.active?'enabled':'disabled'}`);
      loadManageAdmins();
    } else {
      alert('Error: ' + (data.error || 'Failed'));
    }
  } catch(e) {
    alert('Error toggling admin');
  }
}

async function deleteAdmin(username) {
  if (!confirm(`Delete admin "${username}"? This cannot be undone.`)) return;
  
  try {
    const res = await fetch(`/admin/api/super/admins/${encodeURIComponent(username)}`, {method:'DELETE'});
    const data = await res.json();
    
    if (data.success) {
      showToast('Admin deleted');
      loadManageAdmins();
    } else {
      alert('Error: ' + (data.error || 'Failed'));
    }
  } catch(e) {
    alert('Error deleting admin');
  }
}

// Load API control panel
async function loadApiControl() {
  const tbody = document.getElementById('apiControlTbody');
  tbody.innerHTML = '<tr><td colspan="5" class="loading-state"><div class="loading-spinner"></div></td></tr>';
  
  try {
    const data = await apiFetch('/admin/api/super/api-settings');
    document.getElementById('totalApiCalls').textContent = (data.total_usage||0).toLocaleString();
    
    const apis = data.settings || {};
    const apiNames = {
      google_safe_browsing: 'Google Safe Browsing',
      virustotal: 'VirusTotal',
      whoisxml: 'WhoisXML',
      screenshot: 'Screenshot Service'
    };
    
    tbody.innerHTML = Object.keys(apis).map(key => {
      const api = apis[key];
      const enabled = api.enabled;
      const statusColor = enabled ? 'var(--green)' : 'var(--red)';
      const statusText = enabled ? 'Enabled' : 'Disabled';
      
      return `<tr>
        <td style="font-weight:600">${apiNames[key] || key}</td>
        <td><span style="color:${statusColor};font-weight:600">${statusText}</span></td>
        <td style="font-weight:600;color:var(--blue)">${(api.usage_count||0).toLocaleString()}</td>
        <td style="color:var(--text2);font-size:12px">${api.last_used?fmtDate(api.last_used):'Never'}</td>
        <td>
          <button class="action-btn" onclick="toggleApi('${key}')" style="border-color:${enabled?'var(--red)':'var(--green)'};color:${enabled?'var(--red)':'var(--green)'}">
            ${enabled?'Disable':'Enable'}
          </button>
        </td>
      </tr>`;
    }).join('');
  } catch(e) {
    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Error loading API settings</td></tr>';
  }
}

async function toggleApi(apiName) {
  try {
    const res = await fetch(`/admin/api/super/api-settings/${apiName}/toggle`, {method:'POST'});
    const data = await res.json();
    
    if (data.success) {
      showToast(`${data.api} ${data.enabled?'enabled':'disabled'}`);
      loadApiControl();
    } else {
      alert('Error: ' + (data.error || 'Failed'));
    }
  } catch(e) {
    alert('Error toggling API');
  }
}

async function resetApiCounters() {
  if (!confirm('Reset all API usage counters to zero?')) return;
  
  try {
    const res = await fetch('/admin/api/super/api-settings/reset-counters', {method:'POST'});
    const data = await res.json();
    
    if (data.success) {
      showToast('API counters reset');
      loadApiControl();
    } else {
      alert('Error: ' + (data.error || 'Failed'));
    }
  } catch(e) {
    alert('Error resetting counters');
  }
}

</script>
</body>
</html>
